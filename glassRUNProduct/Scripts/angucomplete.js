angular.module("angucomplete",[]).directive("angucomplete",function(b,a,c,d){return{restrict:"EA",scope:{id:"@id",placeholder:"@placeholder",selectedObject:"=selectedobject",url:"@url",dataField:"@datafield",titleField:"@titlefield",descriptionField:"@descriptionfield",imageField:"@imagefield",imageUri:"@imageuri",inputClass:"@inputclass",userPause:"@pause",localData:"=localdata",searchFields:"@searchfields",minLengthUser:"@minlength",matchClass:"@matchclass"},template:'<div class="angucomplete-holder"><input id="{{id}}_value" ng-model="searchStr" type="text" placeholder="{{placeholder}}" class="{{inputClass}}" onmouseup="this.select();" ng-focus="resetHideResults()" ng-blur="hideResults()" /><div id="{{id}}_dropdown" class="angucomplete-dropdown" ng-if="showDropdown"><div class="angucomplete-searching" ng-show="searching">Searching...</div><div class="angucomplete-searching" ng-show="!searching && (!results || results.length == 0)">No results found</div><div class="angucomplete-row" ng-repeat="result in results" ng-mousedown="selectResult(result)" ng-mouseover="hoverRow()" ng-class="{\'angucomplete-selected-row\': $index == currentIndex}"><div ng-if="imageField" class="angucomplete-image-holder"><img ng-if="result.image && result.image != \'\'" ng-src="{{result.image}}" class="angucomplete-image"/><div ng-if="!result.image && result.image != \'\'" class="angucomplete-image-default"></div></div><div class="angucomplete-title" ng-if="matchClass" ng-bind-html="result.title"></div><div class="angucomplete-title" ng-if="!matchClass">{{ result.title }}</div><div ng-if="result.description && result.description != \'\'" class="angucomplete-description">{{result.description}}</div></div></div></div>',link:function(e,g,f){e.lastSearchTerm=null;e.currentIndex=null;e.justChanged=false;e.searchTimer=null;e.hideTimer=null;e.searching=false;e.pause=500;e.minLength=3;e.searchStr=null;if(e.minLengthUser&&e.minLengthUser!=""){e.minLength=e.minLengthUser}if(e.userPause){e.pause=e.userPause}isNewSearchNeeded=function(i,j){return i.length>=e.minLength&&i!=j};e.processResults=function(o,q){if(o&&o.length>0){e.results=[];var w=[];if(e.titleField&&e.titleField!=""){w=e.titleField.split(",")}for(var k=0;k<o.length;k++){var v=[];for(var s=0;s<w.length;s++){v.push(o[k][w[s]])}var j="";if(e.descriptionField){j=o[k][e.descriptionField]}var m="";if(e.imageUri){m=e.imageUri}var l="";if(e.imageField){l=m+o[k][e.imageField]}var u=v.join(" ");if(e.matchClass){var n=new RegExp(q,"i");var r=u.match(n)[0];u=c.trustAsHtml(u.replace(n,'<span class="'+e.matchClass+'">'+r+"</span>"))}var p={title:u,description:j,image:l,originalObject:o[k]};e.results[e.results.length]=p}}else{e.results=[]}};e.searchTimerComplete=function(o){if(o.length>=e.minLength){if(e.localData){var n=e.searchFields.split(",");var l=[];for(var j=0;j<e.localData.length;j++){var k=false;for(var m=0;m<n.length;m++){k=k||(typeof e.localData[j][n[m]]==="string"&&typeof o==="string"&&e.localData[j][n[m]].toLowerCase().indexOf(o.toLowerCase())>=0)}if(k){l[l.length]=e.localData[j]}}e.searching=false;e.processResults(l,o)}else{a.get(e.url+o,{}).success(function(q,r,p,i){e.searching=false;e.processResults(((e.dataField)?q[e.dataField]:q),o)}).error(function(p,r,q,i){console.log("error")})}}};e.hideResults=function(){e.hideTimer=d(function(){e.showDropdown=false},e.pause)};e.resetHideResults=function(){if(e.hideTimer){d.cancel(e.hideTimer)}};e.hoverRow=function(i){e.currentIndex=i};e.keyPressed=function(i){if(!(i.which===38||i.which===40||i.which===13)){if(!e.searchStr||e.searchStr===""){e.showDropdown=false;e.lastSearchTerm=null}else{if(isNewSearchNeeded(e.searchStr,e.lastSearchTerm)){e.lastSearchTerm=e.searchStr;e.showDropdown=true;e.currentIndex=-1;e.results=[];if(e.searchTimer){d.cancel(e.searchTimer)}e.searching=true;e.searchTimer=d(function(){e.searchTimerComplete(e.searchStr)},e.pause)}}}else{i.preventDefault()}};e.selectResult=function(i){if(e.matchClass){i.title=i.title.toString().replace(/(<([^>]+)>)/ig,"")}e.searchStr=e.lastSearchTerm=i.title;e.selectedObject=i;e.showDropdown=false;e.results=[]};var h=g.find("input");h.on("keyup",e.keyPressed);g.on("keyup",function(i){if(i.which===40){if(e.results&&(e.currentIndex+1)<e.results.length){e.currentIndex++;e.$apply();i.preventDefault;i.stopPropagation()}e.$apply()}else{if(i.which==38){if(e.currentIndex>=1){e.currentIndex--;e.$apply();i.preventDefault;i.stopPropagation()}}else{if(i.which==13){if(e.results&&e.currentIndex>=0&&e.currentIndex<e.results.length){e.selectResult(e.results[e.currentIndex]);e.$apply();i.preventDefault;i.stopPropagation()}else{e.results=[];e.$apply();i.preventDefault;i.stopPropagation()}}else{if(i.which==27){e.results=[];e.showDropdown=false;e.$apply()}else{if(i.which==8){e.selectedObject=null;e.$apply()}}}}}})}}});